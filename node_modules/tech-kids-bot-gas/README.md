# Tech Kids Bot GAS

Google Chat の Bot「Tech Kids Bot」を GAS から操作するライブラリ。

## リンク

- **Tech Kids Bot**: Google Chat で「Tech Kids Bot」と検索すると出てくる Bot
- **Google Apps Script**: https://script.google.com/home/projects/1MsT4bkN-LvRE4tkOeCdcB6mJArVglunbg9YLVhfT0OGDUPKVFBdxva8M
- **Google Cloud Project**: https://console.cloud.google.com?project=strategic-howl-364406

## 使い方

### インストール

```sh
npm i https://github.com/techkids-beta/tech-kids-bot-gas
```

スクリプト ID(GAS の実行時に必要)

```
1MsT4bkN-LvRE4tkOeCdcB6mJArVglunbg9YLVhfT0OGDUPKVFBdxva8M
```

### 使用例

```ts
// インポートと初期化
import { TechKidsBotGAS } from "tech-kids-bot-gas";
const googleChat = new TechKidsBotGAS.GoogleChat();

// 指定したスペースやDMにメッセージを投稿する。
// スペースのIDはURLの `dm` や `space` の後に続く文字列。
// スペースにはTech Kids Botが所属している必要がある。
googleChat.sendSpaceMessage("XXXXX", { text: "Hello world!" });

// メンションを飛ばす場合は第3引数としてメールアドレスの配列を渡す
googleChat.sendSpaceMessage("XXXXX", { text: "Hello world!" }, [
  "suda_mikihiro@ca-techkids.com",
  "daigo_natsuki@ca-techkids.com",
]);

// 指定したメールアドレスの相手にDMを送る
const mention = true;
googleChat.sendDirectMessage(
  "xxxxx@ca-techkids.com",
  { text: "Hello world!" },
  mention
);

// Tech Kids Botが所属している全てのスペースやDMをリストアップする。
const spaces = googleChat.listSpaces();
console.log(spaces.map((space) => space.displayName));

// 指定したスペースやDMに存在するメンバーを取得してログ出力する。
// スペースのIDはURLの `dm` や `space` の後に続く文字列。
// スペースにはTech Kids Botが所属している必要がある。
const members = googleChat.listSpaceMember("XXXXX");
console.log(members.map((member) => member.member?.displayName));

// メールアドレスの配列からユーザーIDの配列を取得する
const userIds = googleChat
  .findUserIdsByEmails([
    "suda_mikihiro@ca-techkids.com",
    "daigo_natsuki@ca-techkids.com",
  ])
  .map((user) => user.userId);
console.log(userIds);

// メールアドレスからユーザーIDを取得する
// 内部的には findUserIdsByEmails を呼び出しているので、
// 複数ユーザーのIDを取得したい場合 findUserIdsByEmails のほうが高速
const userId = googleChat.findUserIdByEmail(
  "suda_mikihiro@ca-techkids.com"
).userId;
console.log(userId);
```

## 開発の諸々

### デプロイ

このプロジェクトのデプロイは後述の[Google Cloud Project の設定と紐付いている](https://console.cloud.google.com/apis/api/chat.googleapis.com/hangouts-chat?project=strategic-howl-364406)ため、毎回同じデプロイ ID でデプロイする必要があります。`clasp deploy` は使用せず、次のコマンドでデプロイしてください。

```sh
npm run deploy:gas
```

Google Apps Script にデプロイさえすれば、Google Cloud Project 側で何か手動でデプロイ処理をする必要は無いようです。

### Google Cloud Project

Google Chat の API を使うためには、コンピュータが取り扱うことができるアカウント「[サービスアカウント](https://cloud.google.com/iam/docs/service-accounts?hl=ja#what_are_service_accounts)」を使用する必要があります。そのサービスアカウントを生成するためには Google Cloud でプロジェクトを作成する必要があります。

このライブラリでは Google Cloud Project として https://console.cloud.google.com/welcome?project=strategic-howl-364406 を使用しています。基本的にエンジニア G のメンバーは「オーナー」の権限を付与し、適宜利用できるようにします。

なお、プロジェクトには「[請求先アカウント](https://blog.g-gen.co.jp/entry/billing-account-explained#%E8%AB%8B%E6%B1%82%E5%85%88%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%81%A8%E3%81%AF)」を紐付けていないため、新たに紐付ける操作を行わない限り課金は発生しません。

### GAS へのデプロイと NPM パッケージの関係

このレポジトリのプログラムは、GAS にデプロイできると同時に NPM パッケージとしてインストールもできるようになっています。NPM パッケージとしてインストールできることで、TypeScript による型安全なプログラミングが実現されます。

GAS にデプロイされるのは `src` ディレクトリの中身です。したがって、 `src` 内のスクリプトは全て GAS にデプロイ可能なプログラムでなければなりません。

NPM パッケージとして振る舞うのは `dist` ディレクトリの中身です。 `npm i https://github.com/techkids-beta/tech-kids-bot-gas` をする際に `dist/index.d.ts` 以外の `dist` の中身が自動生成されます(これは `package.json` の `prepare` コマンドで[実現](https://docs.npmjs.com/cli/v8/using-npm/scripts#life-cycle-scripts)しています)。`dist/index.d.ts` は `TechKidsBotGAS` というグローバルオブジェクトを定義し、そのプロパティとして `GoogleChat` を紐付ける役割があります。こうすることにより、GAS ライブラリとしてインポートした際との整合性が保たれます。

### DM 送信先の管理

`src/manageDMs.ts` により、DM 送信先の管理をしています。

DM の送信先は[専用のスプレッドシート](https://docs.google.com/spreadsheets/d/1siH4X0uVNacF29s78IzH_dL-jwSVlXGPugJy45Y156A)で管理しています。`src/manageDMs.ts` はこのシートを読み書きするプログラムです。このプログラムには、毎日深夜 2:30 にシートの情報を最新のものに更新するプログラムが含まれています。

DM を一斉送信する際などはシートの読み取りが短時間に何度も行われることが想定されます。API の呼び出し回数を抑えるとともに実行時間を短縮するため、一度シートの内容を読み取ると 60 秒間シートの内容がキャッシュされ、キャッシュがある場合はキャッシュの内容を返します。

## 既知のバグ

see: https://github.com/techkids-beta/tech-kids-bot-gas/issues/

## メモ：このプロジェクトを参考にする人のための Tips

つまづいたポイントを羅列します。このプロジェクトを参考に新たなプロジェクトを作る際は、下記を参考に正しく設定などができているかチェックしてください。

- [ ] `appsscirpt.json` に `chat` プロパティを追加する
  - 参考：https://developers.google.com/chat/how-tos/apps-script#manifest_file
  - この設定をしないと、ログに Internal server error が出続けます
